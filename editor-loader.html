<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>エディタローダー - CYBER BLITZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: black;
      color: cyan;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }

    .dropzone {
      border: 2px dashed cyan;
      padding: 2rem;
      width: 80%;
      max-width: 500px;
      margin: 1rem;
      cursor: pointer;
      text-shadow: 0 0 5px cyan;
    }

    .dropzone:hover {
      background-color: rgba(0, 255, 255, 0.05);
    }

    .status {
      color: magenta;
      margin-top: 1rem;
    }

    .note {
      color: #aaa;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="dropzone" id="dropzone">
    <p><span style="color:magenta">音楽ファイルと chart.json をドラッグ＆ドロップ</span></p>
    <p>またはクリックして選択</p>
  </div>

  <input type="file" id="fileInput" multiple accept=".mp3,.wav,.json"/>

  <div class="status" id="status">オーディオ: ❌ | チャート: なし</div>
  <div class="note">※ オーディオのみでも新規作成で起動します</div>

  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const status = document.getElementById("status");

    let audioFile = null;
    let chartFile = null;

    function updateStatus() {
      status.textContent =
        `オーディオ: ${audioFile?.name || '❌'} | チャート: ${chartFile?.name || 'なし（新規）'}`;
    }

    function proceedToEditor(base64Audio) {
      sessionStorage.setItem("audioURL", base64Audio);

      if (chartFile) {
        const reader = new FileReader();
        reader.onload = () => {
          sessionStorage.setItem("chartData", reader.result);
          location.href = "editor.html";
        };
        reader.readAsText(chartFile);
      } else {
        sessionStorage.setItem("chartData", "[]");
        location.href = "editor.html";
      }
    }

    function handleFiles(files) {
      for (let f of files) {
        if (f.type.startsWith("audio/")) audioFile = f;
        else if (f.name.endsWith(".json")) chartFile = f;
      }

      updateStatus();

      if (audioFile) {
        const reader = new FileReader();
        reader.onload = () => {
          proceedToEditor(reader.result);
        };
        reader.readAsDataURL(audioFile); // Base64形式で格納
      }
    }

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.style.backgroundColor = "rgba(0,255,255,0.05)";
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.style.backgroundColor = "transparent";
    });

    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.style.backgroundColor = "transparent";
      handleFiles(e.dataTransfer.files);
    });

    dropzone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));
  </script>
</body>
</html>
